---
description: Este documento explica cómo autenticarse utilizando el método OAuth2.0, disponible a partir de la versión 2023.9.0.
---

# Obteniendo un Token de Acceso a través de OAuth

Para obtener un token de acceso para un usuario de la aplicación (en lo sucesivo denominado simplemente "usuario"), solicita su emisión siguiendo estos pasos

:::tip

El método descrito a continuación se denomina [OAuth 2.0](https://datatracker.ietf.org/doc/html/rfc6749.html).A diferencia del OAuth normal que requiere la creación de una app, este método puede utilizarse sin crear una app a través de una extensión llamada [IndieAuth](https://indieauth.spec.indieweb.org/).

Hay muchas bibliotecas disponibles para OAuth, por lo que se recomienda utilizar una si es posible.

Actualmente, se requiere una página web para utilizar este método.Si no puedes proporcionar una página web o necesitas compatibilidad con versiones de Misskey anteriores a 2023.9.0, utiliza uno de los siguientes métodos:

- [MiAuth](./miauth.md)
- [Método heredado para obtener tokens de acceso mediante la creación de aplicaciones](./app.md)

:::

## Paso 1

Crea una página web para presentar tu aplicación.Asegúrate de que la página es accesible mediante una dirección HTTPS.Incluye el siguiente código HTML en algún lugar de la página:

```html
<!-- (Campo obligatorio) La dirección en href es la dirección de envío del código de autorización. -->
<link rel="redirect_uri" href="/redirect">

<div class="h-app">
  <!-- (Opcional/v2025.3.0 o posterior) Puede especificar un logotipo para la aplicación. Se recomienda un logotipo con una relación de aspecto de 1:1 -->
  <img src="/logo.png" class="u-logo">
  <!-- (Opcional) Especifique el nombre de la aplicación que se mostrará al usuario. Si no hay ninguno, se utilizará la dirección de esta página como nombre. -->
	<a href="/" class="u-url p-name">My Misskey App</a>
</div>
```

El código de autenticación se reenviará posteriormente a la dirección de la `redirect_uri`.

## Paso 2

Genera las cadenas PKCE `code_verifier` y `code_challenge`, así como una cadena `state`.

- El  `code_verifier` debe tener entre 43 y 128 caracteres y contener solo letras, dígitos y los caracteres `-._~`.
- El `code_challenge` es el `code_verifier` con hash SHA256 y codificado en base64url.
- La cadena `state` no tiene restricciones especiales.Utiliza una cadena aleatoria.

:::danger

Esta cadena debe generarse cada vez y no utilizarse una y otra vez.

:::

:::tip

Se recomienda utilizar librerías como [pkce-challenge](https://www.npmjs.com/package/pkce-challenge) o librerías OAuth con funcionalidad PKCE.

:::

:::tip{label='例'}

```js
import crypto from "node:crypto";

const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-._~";
const codeVerifier = new Array(128)
  .fill(0)
  .map(() => chars[Math.floor(chars.length * Math.random())])
  .join("");
console.log('code_verifier', codeVerifier);

const codeChallenge = crypto
  .createHash("sha256")
  .update(codeVerifier, "ascii")
  .digest("base64url");
console.log('code_challenge', codeChallenge);

const state = crypto.randomUUID();
console.log('state', state);
```

:::

## Paso 3

Recupera la información OAuth del servidor de destino.Los datos están en formato JSON.

```
https://{host}/.well-known/oauth-authorization-server
```

Sustituye `{host}` por el nombre  del servidor del usuario.Normalmente, el host lo introduce el usuario.

Usarás el `authorization_endpoint` y `token_endpoint` en el siguiente paso.

:::tip

También puedes confirmar la información de `scope` con `scopes_supported`.

:::

## Paso 4

Mostrar el formulario de autenticación de la aplicación en el navegador del usuario.Puedes abrir el formulario de autenticación utilizando una URL con el siguiente formato:

```
{authorization_endpoint}?client_id={client_id}&response_type=code&redirect_uri={redirect_uri}&scope={scope}&code_challenge={code_challenge}&code_challenge_method=S256&state={state}
```

Aquí

- Sustituye `{authorization_endpoint}` por la dirección obtenida en el paso anterior.
- Sustituye `{client_id}` por la dirección de la página de presentación de tu aplicación.
- Sustituye `{code_challenge}` por la cadena `code_challenge` generada previamente.
- La parte `code_challenge_method` debe ser siempre `S256`.
- Sustituye  `{redirect_uri}` con la dirección utilizada en su página de introducción.
- Sustituye `{scope}` por los permisos que requiere tu aplicación, separados por espacios.Usa espacios \`\`, no comas.Comprueba la lista de permisos [aquí](../permission.md).
- Reemplaza `{state}` con la cadena de texto `state` generada anteriormente

:::tip{label='例'}

```
https://misskey.local/oauth/authorize?client_id=http%3A%2F%2Fexample.com&code_challenge=C6hwMO2bmIzg3nqppTE9b79fvuOjlrKmH2xNiZSMHzw&code_challenge_method=S256&response_type=code&redirect_uri=http%3A%2F%2Fexample.com%2Fredirect&scope=write%3Anotes&state=87c11f05-86eb-4eb2-9057-f6a98fc5e9ab
```

:::

## Paso 5

Una vez que el usuario conceda acceso a la aplicación, será redirigido a la página especificada como `redirect_uri`.

| Nombre  | Descripción                                                                  |
| ------- | ---------------------------------------------------------------------------- |
| `code`  | El código de autorización del usuario.                       |
| `state` | La cadena `state` utilizada en la solicitud de autorización. |

:::tip{label='例'}

```
https://example.com/redirect?code=...&state=87c11f05-86eb-4eb2-9057-f6a98fc5e9ab
```

:::

Comprueba que la cadena de estado coincide y continúa con el siguiente paso.

## Paso 6

Utiliza el código de autorización que obtengas para solicitar un token de acceso mediante POST.La petición se realizará a `token_endpoint`.El formato de los datos puede ser `application/json` o `application/x-www-form-urlencoded`.Los parámetros son los siguientes.

| Nombre          | Descripción                                                                         |
| --------------- | ----------------------------------------------------------------------------------- |
| `grant_type`    | Siempre se establece en `authorization_code`.                       |
| `client_id`     | La cadena `client_id` utilizada en la solicitud de autorización.    |
| `redirect_uri`  | La cadena `redirect_uri` utilizada en la solicitud de autorización. |
| `scope`         | La cadena `scope` utilizada en la solicitud de autorización.        |
| `code`          | El código de autorización obtenido                                                  |
| `code_verifier` | La cadena `code_verifier` generada previamente.                     |

:::tip{label='例'}

```js
const res = await fetch(endpoint, {
  method: "POST",
  body: JSON.stringify({
    grant_type: "authorization_code",
    client_id: "https://example.com",
    redirect_uri: "https://example.com/redirect",
    scope: "write:notes",
    code: "...",
    code_verifier: "hjjbCYDmDpSLjirkO-PrfWKsRhDdJr-PAEGRClRwzUKlmFIIIrZNmSvUIraeIa~WqbqQnfbJV-Hc_IfuQkesBYUpukUi~lInDfU_AZjoZqbU.ioQTRzaFfZFfGnT-OAA",
  }),
  headers: {
    "Content-Type": "application/json"
  }
});
```

:::

La respuesta será un objeto JSON del que podrás obtener y utilizar el `access_token`.
